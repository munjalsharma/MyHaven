<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>MyHaven â€“ Chat with Haven</title>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=container-queries"></script>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#5b4cf5",
                    "primary-hover": "#4a3de0",
                    "background-light": "#f0edfc",
                    "background-dark": "#111121",
                    "surface-dark": "#1e1e24",
                    "surface-light": "#ffffff",
                    "purple-msg": "#5b4cf5",
                },
                fontFamily: {
                    "display": ["Lexend", "sans-serif"],
                    "body": ["Noto Sans", "sans-serif"],
                },
                borderRadius: {
                    "DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"
                },
            },
        },
    }
</script>
<style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #242447; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #5b4cf5; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50%       { transform: translateY(-5px); }
    }
    .dot { width:8px;height:8px;border-radius:50%;background:#9ca3af;display:inline-block;animation:bounce 1.2s infinite; }
    .dot:nth-child(2){ animation-delay:.2s; }
    .dot:nth-child(3){ animation-delay:.4s; }

    @keyframes fadeUp {
        from { opacity:0; transform:translateY(12px); }
        to   { opacity:1; transform:translateY(0); }
    }
    .msg-appear { animation: fadeUp .28s ease-out forwards; }

    @keyframes pulseGlow {
        0%,100% { box-shadow:0 0 0 0 rgba(91,76,245,.5); }
        50%      { box-shadow:0 0 0 7px rgba(91,76,245,0); }
    }
    .online-ring { animation: pulseGlow 2.2s infinite; }

    .bar-fill { transition: width .7s cubic-bezier(.4,0,.2,1); }
    textarea { font-family:'Noto Sans',sans-serif; }
    textarea:focus { outline:none; box-shadow:none; }

    /* â”€â”€ Chip styles â”€â”€ */
    .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 9999px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        border: 1.5px solid transparent;
        transition: all 0.18s ease;
        letter-spacing: 0.01em;
    }
    .chip:hover { transform: translateY(-2px); }
    .chip:active { transform: translateY(0px); }

    /* chip colour variants */
    .chip-red    { background: rgba(239,68,68,.12);  color:#f87171; border-color:rgba(239,68,68,.25); }
    .chip-red:hover    { background:rgba(239,68,68,.22); border-color:rgba(239,68,68,.5); }

    .chip-amber  { background: rgba(245,158,11,.12); color:#fbbf24; border-color:rgba(245,158,11,.25); }
    .chip-amber:hover  { background:rgba(245,158,11,.22); border-color:rgba(245,158,11,.5); }

    .chip-blue   { background: rgba(59,130,246,.12); color:#60a5fa; border-color:rgba(59,130,246,.25); }
    .chip-blue:hover   { background:rgba(59,130,246,.22); border-color:rgba(59,130,246,.5); }

    .chip-green  { background: rgba(34,197,94,.12);  color:#4ade80; border-color:rgba(34,197,94,.25); }
    .chip-green:hover  { background:rgba(34,197,94,.22); border-color:rgba(34,197,94,.5); }

    .chip-purple { background: rgba(168,85,247,.12); color:#c084fc; border-color:rgba(168,85,247,.25); }
    .chip-purple:hover { background:rgba(168,85,247,.22); border-color:rgba(168,85,247,.5); }

    .chip-pink   { background: rgba(236,72,153,.12); color:#f472b6; border-color:rgba(236,72,153,.25); }
    .chip-pink:hover   { background:rgba(236,72,153,.22); border-color:rgba(236,72,153,.5); }

    /* light mode overrides for chips */
    html:not(.dark) .chip-red    { background:rgba(239,68,68,.08);  color:#dc2626; border-color:rgba(239,68,68,.2); }
    html:not(.dark) .chip-amber  { background:rgba(245,158,11,.08); color:#d97706; border-color:rgba(245,158,11,.2); }
    html:not(.dark) .chip-blue   { background:rgba(59,130,246,.08); color:#2563eb; border-color:rgba(59,130,246,.2); }
    html:not(.dark) .chip-green  { background:rgba(34,197,94,.08);  color:#16a34a; border-color:rgba(34,197,94,.2); }
    html:not(.dark) .chip-purple { background:rgba(168,85,247,.08); color:#9333ea; border-color:rgba(168,85,247,.2); }
    html:not(.dark) .chip-pink   { background:rgba(236,72,153,.08); color:#db2777; border-color:rgba(236,72,153,.2); }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display overflow-hidden h-screen flex flex-col md:flex-row transition-colors duration-300">

<!-- â•â• LEFT SIDEBAR â•â• -->
<aside class="w-full md:w-[260px] hidden md:flex flex-col justify-between border-r border-gray-200 dark:border-[#242447] bg-white dark:bg-background-dark shrink-0 p-4 z-20 transition-colors duration-300">
    <div class="flex flex-col gap-6">
        <div class="flex items-center gap-3 px-2">
            <div class="size-8 text-primary bg-primary/20 rounded-full flex items-center justify-center">
                <span class="material-symbols-outlined text-lg">spa</span>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-gray-900 dark:text-white">MyHaven</h1>
        </div>
        <nav class="flex flex-col gap-2">
            <a class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-[#242447] text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors" href="index.html">
                <span class="material-symbols-outlined">home</span>
                <span class="text-sm font-medium">Home</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-xl bg-gray-100 dark:bg-[#242447] text-gray-900 dark:text-white transition-colors shadow-sm" href="#">
                <span class="material-symbols-outlined">chat_bubble</span>
                <span class="text-sm font-medium">Chat</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-[#242447] text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors" href="team.html">
                <span class="material-symbols-outlined">groups</span>
                <span class="text-sm font-medium">About Team</span>
            </a>
        </nav>
    </div>
    <div class="pt-4 border-t border-gray-200 dark:border-[#242447]">
        <a href="tel:9152987821">
            <button class="w-full flex items-center justify-center gap-2 bg-red-600/90 hover:bg-red-600 text-white rounded-full h-12 px-4 transition-all shadow-lg group">
                <span class="material-symbols-outlined group-hover:scale-110 transition-transform">sos</span>
                <span class="text-sm font-bold tracking-wide">Crisis Hotline</span>
            </button>
        </a>
        <p class="text-xs text-center text-gray-500 mt-3">Kiran: 9152987821 Â· 24/7 Free</p>
    </div>
</aside>

<!-- â•â• MAIN CHAT â•â• -->
<main class="flex-1 flex flex-col min-w-0 bg-background-light dark:bg-[#111122] relative transition-colors duration-300">

    <!-- Header -->
    <header class="h-16 flex items-center justify-between px-6 border-b border-gray-200 dark:border-[#242447] bg-white/95 dark:bg-[#111122]/95 backdrop-blur-sm z-10 transition-colors duration-300 shrink-0">
        <div class="flex items-center gap-4">
            <div class="relative">
                <div class="size-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center online-ring">
                    <span class="material-symbols-outlined text-white text-lg">self_improvement</span>
                </div>
                <div class="absolute bottom-0 right-0 size-3 bg-green-400 border-2 border-white dark:border-[#111122] rounded-full"></div>
            </div>
            <div>
                <h2 class="text-gray-900 dark:text-white text-base font-bold leading-tight flex items-center gap-2">
                    Haven
                    <span class="px-1.5 py-0.5 rounded-full bg-gray-100 dark:bg-[#242447] text-[10px] font-semibold text-primary">AI Companion</span>
                </h2>
                <p id="status-text" class="text-xs text-gray-500 dark:text-gray-400">Your safe space to talk</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button type="button" onclick="resetChat()" class="flex items-center gap-1.5 px-3 h-9 bg-gray-100 dark:bg-[#242447] hover:bg-primary/10 dark:hover:bg-[#5b4cf5]/20 text-gray-700 dark:text-gray-200 text-xs font-semibold rounded-full transition-colors border border-gray-200 dark:border-white/5">
                <span class="material-symbols-outlined text-[15px]">refresh</span> New Chat
            </button>
            <button type="button" onclick="toggleTheme()" class="flex items-center justify-center size-9 bg-gray-100 dark:bg-[#242447] hover:bg-gray-200 dark:hover:bg-[#5b4cf5]/20 text-gray-500 dark:text-gray-300 rounded-full transition-colors">
                <span class="material-symbols-outlined text-[18px]">dark_mode</span>
            </button>
        </div>
    </header>

    <!-- Messages -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:px-8 md:py-6 flex flex-col gap-4">
        <div class="flex justify-center sticky top-0 z-0 pt-1 pb-2">
            <div class="bg-white/80 dark:bg-[#242447]/80 backdrop-blur text-gray-500 dark:text-[#9393c8] text-xs py-1.5 px-4 rounded-full flex items-center gap-1.5 shadow-sm border border-gray-200 dark:border-white/5">
                <span class="material-symbols-outlined text-[14px]">lock</span>
                Conversations are 100% confidential &amp; encrypted
            </div>
        </div>
        <div class="flex justify-center">
            <span id="chat-date" class="text-xs font-medium text-gray-400 dark:text-gray-600"></span>
        </div>
    </div>

    <!-- Input Area -->
    <div class="bg-white dark:bg-[#111122] border-t border-gray-200 dark:border-[#242447] p-4 flex flex-col gap-3 transition-colors duration-300 shrink-0">

        <!-- â”€â”€ CHIPS â”€â”€ -->
        <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">

            <button type="button" onclick="sendChip(this,'I need to vent about something that\'s been bothering me')"
                class="chip chip-red">
                <span class="material-symbols-outlined text-[16px]">sentiment_very_dissatisfied</span>
                Venting
            </button>

            <button type="button" onclick="sendChip(this,'I\'m feeling really anxious and overwhelmed right now')"
                class="chip chip-amber">
                <span class="material-symbols-outlined text-[16px]">sentiment_worried</span>
                Anxiety
            </button>

            <button type="button" onclick="sendChip(this,'Exams are stressing me out a lot')"
                class="chip chip-blue">
                <span class="material-symbols-outlined text-[16px]">menu_book</span>
                Study stress
            </button>

            <button type="button" onclick="sendChip(this,'I\'m feeling really low and sad today')"
                class="chip chip-purple">
                <span class="material-symbols-outlined text-[16px]">mood_bad</span>
                Feeling low
            </button>

            <button type="button" onclick="sendChip(this,'Can you suggest something to help me relax and calm down?')"
                class="chip chip-green">
                <span class="material-symbols-outlined text-[16px]">spa</span>
                Relaxation
            </button>

            <button type="button" onclick="sendChip(this,'I just need someone to talk to right now')"
                class="chip chip-pink">
                <span class="material-symbols-outlined text-[16px]">record_voice_over</span>
                Just talk
            </button>

        </div>

        <!-- Textarea row -->
        <div class="flex items-end gap-2 bg-gray-50 dark:bg-[#1e1e24] p-2 pl-4 rounded-[24px] border border-gray-300 dark:border-[#242447] focus-within:border-primary/50 transition-colors shadow-sm">
            <textarea
                id="msg-input"
                rows="1"
                class="w-full bg-transparent border-none text-gray-900 dark:text-white placeholder-gray-400 focus:ring-0 resize-none py-2 max-h-32 text-sm leading-relaxed"
                placeholder="Share what's on your mindâ€¦"
                onkeydown="handleKey(event)"
                oninput="autoResize(this)"
            ></textarea>
            <button type="button" onclick="sendMessage()" id="send-btn"
                class="p-2 bg-purple-msg hover:bg-primary-hover text-white rounded-full transition-all flex items-center justify-center h-10 w-10 shrink-0 shadow-lg shadow-primary/20 hover:scale-105">
                <span class="material-symbols-outlined text-[20px] translate-x-0.5">send</span>
            </button>
        </div>
        <p class="text-[10px] text-center text-gray-400 dark:text-gray-600">
            MyHaven is an AI companion. For emergencies call <strong>9152987821</strong> (Kiran Â· Free Â· 24/7).
        </p>
    </div>
</main>

<!-- â•â• RIGHT SIDEBAR â•â• -->
<aside class="w-[320px] hidden xl:flex flex-col border-l border-gray-200 dark:border-[#242447] bg-white dark:bg-background-dark shrink-0 overflow-y-auto transition-colors duration-300">

    <!-- Profile -->
    <div class="p-6 border-b border-gray-200 dark:border-[#242447]">
        <div class="flex items-center gap-4">
            <div class="size-14 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center">
                <span class="material-symbols-outlined text-white text-2xl">person</span>
            </div>
            <div>
                <h3 id="profile-name" class="text-gray-900 dark:text-white font-bold text-base">You</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400">Session active</p>
            </div>
        </div>
    </div>

    <div class="p-5 flex flex-col gap-5">

        <!-- Context tags -->
        <div id="context-panel" class="hidden bg-gray-50 dark:bg-surface-dark rounded-2xl p-4 border border-gray-200 dark:border-[#242447]">
            <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-2">Haven knows about you</p>
            <div id="context-tags" class="flex flex-wrap gap-1.5"></div>
        </div>

        <!-- Emotion -->
        <div class="bg-gray-50 dark:bg-surface-dark rounded-2xl p-5 border border-gray-200 dark:border-[#242447] shadow-sm">
            <div class="flex items-center justify-between mb-3">
                <h4 class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-widest">Emotion Detected</h4>
                <span class="material-symbols-outlined text-primary text-lg">sentiment_satisfied</span>
            </div>
            <div class="flex items-center gap-3 mb-4">
                <span id="emotion-emoji" class="text-4xl transition-all duration-500">ğŸ™‚</span>
                <div>
                    <p id="emotion-label" class="text-xl font-bold text-gray-900 dark:text-white">Neutral</p>
                    <p id="emotion-confidence" class="text-xs text-gray-500 dark:text-gray-400">Confidence: â€”</p>
                </div>
            </div>
            <div class="w-full bg-gray-200 dark:bg-[#111122] rounded-full h-1.5 mb-3">
                <div id="emotion-bar" class="bar-fill bg-gradient-to-r from-primary to-indigo-400 h-1.5 rounded-full" style="width:0%"></div>
            </div>
            <div class="flex flex-wrap gap-1.5" id="emotion-pills"></div>
            <p id="emotion-note" class="text-[10px] text-gray-400 dark:text-gray-500 mt-3">Waiting for your messageâ€¦</p>
            <p class="text-[10px] text-gray-400 dark:text-gray-500 mt-0.5">Powered by MuRIL-BERT</p>
        </div>

        <!-- Sentiment -->
        <div class="bg-gray-50 dark:bg-surface-dark rounded-2xl p-5 border border-gray-200 dark:border-[#242447] shadow-sm">
            <div class="flex items-center justify-between mb-3">
                <h4 class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-widest">Sentiment</h4>
                <span class="material-symbols-outlined text-primary text-lg">analytics</span>
            </div>
            <div class="flex items-center gap-3 mb-4">
                <span id="sentiment-badge" class="px-3 py-1 rounded-full text-sm font-bold bg-gray-200 dark:bg-[#242447] text-gray-600 dark:text-gray-300 transition-all duration-500">â€”</span>
            </div>
            <div class="mb-3">
                <div class="flex justify-between text-[10px] text-gray-500 mb-1"><span>Negative</span><span>Polarity</span><span>Positive</span></div>
                <div class="relative w-full bg-gray-200 dark:bg-[#111122] rounded-full h-2">
                    <div class="absolute left-1/2 top-0 h-2 w-0.5 bg-gray-400 dark:bg-gray-600 -translate-x-1/2"></div>
                    <div id="polarity-bar" class="bar-fill absolute h-2 rounded-full" style="left:50%;width:0%"></div>
                </div>
                <p id="polarity-val" class="text-xs text-center text-gray-500 dark:text-gray-400 mt-1">â€”</p>
            </div>
            <div>
                <div class="flex justify-between text-[10px] text-gray-500 mb-1"><span>Objective</span><span>Subjectivity</span><span>Subjective</span></div>
                <div class="w-full bg-gray-200 dark:bg-[#111122] rounded-full h-2">
                    <div id="subjectivity-bar" class="bar-fill bg-gradient-to-r from-orange-400 to-amber-400 h-2 rounded-full" style="width:0%"></div>
                </div>
                <p id="subjectivity-val" class="text-xs text-center text-gray-500 dark:text-gray-400 mt-1">â€”</p>
            </div>
            <p id="sentiment-note" class="text-[10px] text-gray-400 dark:text-gray-500 mt-3">Waiting for your messageâ€¦</p>
        </div>

        <!-- Daily Goals 
        <div class="flex flex-col gap-3">
            <h4 class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-widest">Daily Goals</h4>
            <div class="flex flex-col gap-2">
                <label class="flex items-center gap-3 p-3 bg-white dark:bg-surface-dark rounded-xl border border-gray-200 dark:border-[#242447] cursor-pointer hover:border-primary/40 transition-colors">
                    <input type="checkbox" class="accent-primary" checked>
                    <span class="text-sm text-gray-500 dark:text-gray-400 line-through">Open Haven</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-white dark:bg-surface-dark rounded-xl border border-gray-200 dark:border-[#242447] cursor-pointer hover:border-primary/40 transition-colors">
                    <input type="checkbox" class="accent-primary">
                    <span class="text-sm text-gray-700 dark:text-gray-200">Meditate 10 mins</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-white dark:bg-surface-dark rounded-xl border border-gray-200 dark:border-[#242447] cursor-pointer hover:border-primary/40 transition-colors">
                    <input type="checkbox" class="accent-primary">
                    <span class="text-sm text-gray-700 dark:text-gray-200">Journal thoughts</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-white dark:bg-surface-dark rounded-xl border border-gray-200 dark:border-[#242447] cursor-pointer hover:border-primary/40 transition-colors">
                    <input type="checkbox" class="accent-primary">
                    <span class="text-sm text-gray-700 dark:text-gray-200">Drink 2L water</span>
                </label>
            </div>
        </div>
        -->

        <!-- Theme toggle -->
        <div class="pt-4 border-t border-gray-200 dark:border-[#242447]">
            <div class="flex items-center justify-between px-3 py-2 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-[#242447] rounded-lg cursor-pointer transition-colors" onclick="toggleTheme()">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-[18px]">dark_mode</span>
                    <span>Dark Mode</span>
                </div>
                <div id="theme-toggle" class="relative inline-flex h-5 w-9 items-center rounded-full bg-primary transition-colors duration-200">
                    <span id="theme-knob" class="translate-x-[18px] inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 shadow-sm"></span>
                </div>
            </div>
        </div>

    </div>
</aside>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
const BACKEND = "https://myhaven.onrender.com";

// Persist USER_ID in localStorage so the same user is recognized across page reloads
let USER_ID = localStorage.getItem("myhaven_user_id");
if (!USER_ID) {
    USER_ID = "user_" + Math.random().toString(36).slice(2,9);
    localStorage.setItem("myhaven_user_id", USER_ID);
}

let isThinking = false;

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener("DOMContentLoaded", async () => {
    document.getElementById("chat-date").textContent = new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
    initEmotionPills();
    syncThemeToggle();

    // sessionStorage survives Live Server hot-reloads but clears when the tab closes.
    // This prevents /start being spammed every time Live Server refreshes the page.
    const alreadyStarted = sessionStorage.getItem("haven_session_started");
    if (!alreadyStarted) {
        sessionStorage.setItem("haven_session_started", "1");
        await startSession();
    } else {
        setStatus("Online Â· Haven");
        appendMessage("haven", "Welcome back! \uD83D\uDC9B What's on your mind?");
    }
});

async function startSession() {
    setStatus("Haven is connecting\u2026");
    try {
        const res  = await fetch(`${BACKEND}/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:USER_ID})});
        const data = await res.json();
        appendMessage("haven", data.reply);
        setStatus("Online \u00B7 Haven");
    } catch {
        appendMessage("haven","Hey! I'm Haven \uD83D\uDC9B It looks like the backend isn't running. Start it with: `uvicorn main:app --reload` inside the backend/ folder, then refresh.");
        setStatus("\u26A0\uFE0F Backend offline");
    }
}

// â”€â”€ SEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
    const input = document.getElementById("msg-input");
    const text  = input.value.trim();
    if (!text || isThinking) return;
    input.value = ""; autoResize(input);
    appendMessage("user", text);
    showTyping(); setStatus("Haven is typingâ€¦"); isThinking = true;
    try {
        const res  = await fetch(`${BACKEND}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:USER_ID,message:text})});
        const data = await res.json();
        hideTyping();
        appendMessage("haven", data.reply);
        updateEmotion(data.emotion);
        updateSentiment(data.sentiment);
        updateContextPanel(data.context);
        setStatus("Online Â· Haven");
    } catch {
        hideTyping();
        appendMessage("haven","Hmm, couldn't reach the server. Is the backend running?");
        setStatus("âš ï¸ Connection error");
    }
    isThinking = false;
}

function handleKey(e){
    if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        e.stopPropagation();
        sendMessage();
        return false;
    }
}

// Global safety net: prevent any Enter keypress from causing a page reload
document.addEventListener("keydown", function(e){
    if(e.key === "Enter" && !e.shiftKey && document.activeElement && document.activeElement.id === "msg-input"){
        e.preventDefault();
        e.stopPropagation();
        sendMessage();
    }
}, true); // true = capture phase, fires BEFORE anything else

function sendChip(btn, message) {
    document.getElementById("msg-input").value = message;
    sendMessage();
}

async function resetChat() {
    try { await fetch(`${BACKEND}/reset`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:USER_ID})}); } catch(_){}
    // Generate a new session ID and clear the guard so startSession fires fresh
    USER_ID = "user_" + Math.random().toString(36).slice(2,9);
    localStorage.setItem("myhaven_user_id", USER_ID);
    sessionStorage.removeItem("haven_session_started");
    document.getElementById("chat-container").innerHTML = `
        <div class="flex justify-center sticky top-0 z-0 pt-1 pb-2">
            <div class="bg-white/80 dark:bg-[#242447]/80 backdrop-blur text-gray-500 dark:text-[#9393c8] text-xs py-1.5 px-4 rounded-full flex items-center gap-1.5 shadow-sm border border-gray-200 dark:border-white/5">
                <span class="material-symbols-outlined text-[14px]">lock</span>
                Conversations are 100% confidential &amp; encrypted
            </div>
        </div>
        <div class="flex justify-center"><span id="chat-date" class="text-xs font-medium text-gray-400 dark:text-gray-600"></span></div>`;
    document.getElementById("chat-date").textContent = new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
    resetSidebar();
    await startSession();
}

// â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendMessage(role, text) {
    const container = document.getElementById("chat-container");
    const isHaven   = role === "haven";
    const wrapper   = document.createElement("div");
    wrapper.className = `flex items-end gap-3 msg-appear ${isHaven?"":"flex-row-reverse"}`;

    const avatar = document.createElement("div");
    avatar.className = isHaven
        ? "size-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center shrink-0 mb-1"
        : "size-8 rounded-full bg-gradient-to-br from-gray-400 to-gray-500 dark:from-gray-600 dark:to-gray-700 flex items-center justify-center shrink-0 mb-1";
    avatar.innerHTML = isHaven
        ? `<span class="material-symbols-outlined text-white text-sm">self_improvement</span>`
        : `<span class="material-symbols-outlined text-white text-sm">person</span>`;

    const html = escapeHtml(text).replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>");
    const bubble = document.createElement("div");
    bubble.className = isHaven
        ? "max-w-[75%] px-4 py-3 rounded-2xl rounded-bl-sm bg-white dark:bg-[#1e1e2e] border border-gray-200 dark:border-[#242447] text-gray-800 dark:text-gray-100 text-sm leading-relaxed shadow-sm"
        : "max-w-[75%] px-4 py-3 rounded-2xl rounded-br-sm bg-purple-msg text-white text-sm leading-relaxed shadow-md shadow-primary/20";
    bubble.innerHTML = html;

    const time = document.createElement("p");
    time.className = "text-[10px] text-gray-400 dark:text-gray-600 mt-1 px-1 " + (isHaven?"text-left":"text-right");
    time.textContent = new Date().toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"});

    const col = document.createElement("div");
    col.className = "flex flex-col " + (isHaven?"":"items-end");
    col.appendChild(bubble); col.appendChild(time);
    wrapper.appendChild(avatar); wrapper.appendChild(col);
    container.appendChild(wrapper);
    container.scrollTop = container.scrollHeight;
}

function escapeHtml(t){ return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

let typingEl = null;
function showTyping(){
    const c=document.getElementById("chat-container");
    typingEl=document.createElement("div");
    typingEl.className="flex items-end gap-3 msg-appear";
    typingEl.id="typing-indicator";
    typingEl.innerHTML=`<div class="size-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center shrink-0"><span class="material-symbols-outlined text-white text-sm">self_improvement</span></div><div class="px-4 py-3 rounded-2xl rounded-bl-sm bg-white dark:bg-[#1e1e2e] border border-gray-200 dark:border-[#242447] shadow-sm flex items-center gap-1.5 h-10"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
    c.appendChild(typingEl); c.scrollTop=c.scrollHeight;
}
function hideTyping(){ if(typingEl){typingEl.remove();typingEl=null;} }

// â”€â”€ EMOTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EMOTION_COLORS = {
    joy:"bg-yellow-100 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-300",
    sadness:"bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300",
    fear:"bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300",
    anger:"bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300",
    surprise:"bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-300",
    neutral:"bg-gray-100 text-gray-600 dark:bg-gray-700/60 dark:text-gray-300",
    disgust:"bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300",
    shame:"bg-pink-100 text-pink-700 dark:bg-pink-900/40 dark:text-pink-300",
};
const ALL_EMOTIONS=["joy","sadness","fear","anger","surprise","neutral","disgust","shame"];

function initEmotionPills(){
    const c=document.getElementById("emotion-pills");
    ALL_EMOTIONS.forEach(e=>{
        const p=document.createElement("span");
        p.id=`pill-${e}`;
        p.className="text-[10px] px-2 py-0.5 rounded-full font-medium opacity-40 bg-gray-100 text-gray-500 dark:bg-gray-700/40 dark:text-gray-400 transition-all duration-300";
        p.textContent=e.charAt(0).toUpperCase()+e.slice(1);
        c.appendChild(p);
    });
}

function updateEmotion(emotion){
    if(!emotion) return;
    const label=(emotion.label||"Neutral").toLowerCase();
    const conf=Math.round((emotion.confidence||0)*100);
    document.getElementById("emotion-emoji").textContent=emotion.emoji||"ğŸ™‚";
    document.getElementById("emotion-label").textContent=emotion.label||"Neutral";
    document.getElementById("emotion-confidence").textContent=`Confidence: ${conf}%`;
    document.getElementById("emotion-bar").style.width=conf+"%";
    document.getElementById("emotion-note").textContent=emotion.note||"";
    ALL_EMOTIONS.forEach(e=>{
        const p=document.getElementById(`pill-${e}`);
        if(!p) return;
        p.className = e===label
            ? `text-[10px] px-2 py-0.5 rounded-full font-bold opacity-100 transition-all duration-300 ${EMOTION_COLORS[e]||EMOTION_COLORS.neutral}`
            : "text-[10px] px-2 py-0.5 rounded-full font-medium opacity-40 bg-gray-100 text-gray-500 dark:bg-gray-700/40 dark:text-gray-400 transition-all duration-300";
    });
}

// â”€â”€ SENTIMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSentiment(sentiment){
    if(!sentiment) return;
    const label=sentiment.label||"Neutral";
    const pol=parseFloat(sentiment.polarity||0);
    const sub=parseFloat(sentiment.subjectivity||0);
    const badge=document.getElementById("sentiment-badge");
    badge.textContent=label;
    badge.className="px-3 py-1 rounded-full text-sm font-bold transition-all duration-500 "+(
        label==="Positive"?"bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300":
        label==="Negative"?"bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300":
        "bg-gray-200 text-gray-600 dark:bg-[#242447] dark:text-gray-300");
    const pBar=document.getElementById("polarity-bar");
    const hw=Math.abs(pol)*50;
    if(pol>=0){pBar.style.left="50%";pBar.style.width=hw+"%";pBar.className="bar-fill absolute h-2 rounded-full bg-gradient-to-r from-green-400 to-emerald-500 transition-all";}
    else{pBar.style.left=(50-hw)+"%";pBar.style.width=hw+"%";pBar.className="bar-fill absolute h-2 rounded-full bg-gradient-to-r from-red-500 to-rose-400 transition-all";}
    document.getElementById("polarity-val").textContent=pol.toFixed(2);
    document.getElementById("subjectivity-bar").style.width=(sub*100)+"%";
    document.getElementById("subjectivity-val").textContent=sub.toFixed(2);
    document.getElementById("sentiment-note").textContent=sentiment.note||"";
}

// â”€â”€ CONTEXT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateContextPanel(ctx){
    if(!ctx) return;
    if(ctx.name) document.getElementById("profile-name").textContent=ctx.name;
    const panel=document.getElementById("context-panel");
    const tags=document.getElementById("context-tags");
    const items=[...(ctx.topics||[]),...(ctx.mood_history||[]).slice(-2)];
    if(items.length>0){
        panel.classList.remove("hidden");
        tags.innerHTML=items.slice(-8).map(t=>
            `<span class="text-[10px] px-2 py-0.5 bg-primary/10 text-primary rounded-full font-medium">${t}</span>`
        ).join("");
    }
}

function resetSidebar(){
    document.getElementById("profile-name").textContent="You";
    document.getElementById("context-panel").classList.add("hidden");
    document.getElementById("context-tags").innerHTML="";
    document.getElementById("emotion-emoji").textContent="ğŸ™‚";
    document.getElementById("emotion-label").textContent="Neutral";
    document.getElementById("emotion-confidence").textContent="Confidence: â€”";
    document.getElementById("emotion-bar").style.width="0%";
    document.getElementById("emotion-note").textContent="Waiting for your messageâ€¦";
    ALL_EMOTIONS.forEach(e=>{
        const p=document.getElementById(`pill-${e}`);
        if(p) p.className="text-[10px] px-2 py-0.5 rounded-full font-medium opacity-40 bg-gray-100 text-gray-500 dark:bg-gray-700/40 dark:text-gray-400 transition-all duration-300";
    });
    document.getElementById("sentiment-badge").textContent="â€”";
    document.getElementById("polarity-bar").style.width="0%";
    document.getElementById("polarity-bar").style.left="50%";
    document.getElementById("polarity-val").textContent="â€”";
    document.getElementById("subjectivity-bar").style.width="0%";
    document.getElementById("subjectivity-val").textContent="â€”";
    document.getElementById("sentiment-note").textContent="Waiting for your messageâ€¦";
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(m){ document.getElementById("status-text").textContent=m; }
function autoResize(el){ el.style.height="auto"; el.style.height=Math.min(el.scrollHeight,128)+"px"; }

function toggleTheme(){
    const isDark=document.documentElement.classList.toggle("dark");
    const knob=document.getElementById("theme-knob");
    const track=document.getElementById("theme-toggle");
    if(isDark){ knob.classList.replace("translate-x-0.5","translate-x-[18px]"); track.classList.replace("bg-gray-300","bg-primary"); }
    else       { knob.classList.replace("translate-x-[18px]","translate-x-0.5"); track.classList.replace("bg-primary","bg-gray-300"); }
}
function syncThemeToggle(){
    const isDark=document.documentElement.classList.contains("dark");
    const knob=document.getElementById("theme-knob");
    const track=document.getElementById("theme-toggle");
    if(!isDark){ knob.classList.replace("translate-x-[18px]","translate-x-0.5"); track.classList.replace("bg-primary","bg-gray-300"); }
}
</script>
</body>
</html>